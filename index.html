<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    
<!-- <input id="mp3name_id" type="text" value="" placeholder="mp3name" rows="10" cols="100" style="display:block; text-align: left; width: 150px;"> -->
<label id="directions" style="display:block">Enter OpenAI key to transcribe the audio files to text. All audio files in the repository will be transcribed.</label>
<br>
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">

<br><br>

<button id="readaudio" onclick="readaudio()">Transcribe audios</button>

<!-- View results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>


<!-- View results -->
<div align="left">
    <table style='text-align: center; width: 600px; display:block'>
      <tr>
        <td>
		<label id="journal_label" style="display:block">Journal text</label>
      		<br>
      		<textarea id="journal" rows="35" cols="100" placeholder="Journal text" style="display:block"></textarea>
	</td>
        <td>
		<label id="chatbot_label" style="display:block">Chatbot area</label>
      		<br>
      		<textarea id="chatbot" rows="35" cols="100" placeholder="Chatbot text" style="display:block"></textarea>
	</td>
      </tr>
    </table>
</div>  
    



	  
<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 2;},
  table {border-collapse: collapse; position: absolute;}
  td,
  th {border: 1px solid black;padding: 10px 20px;}
</style>

<script>

// ----------------------------------------------------

const outp = document.getElementById('output');


	
async function readaudio() {

  const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;

  await get_URLBlob()
	.then(url_list => {
		// console.log("url_list:", url_list);
		var dict_out = [];
		url_list.forEach(async function(row, index) {
			let dat = Object.values(row.date).toString();
			let out0 = dat.split('_');
			let date = out0.slice(0,2);
			let time = out0.slice(3,5);
			
			// let blob_url = '@'+Object.values(row.url_name).toString(); // TypeError: can't convert undefined to object
			// let blob_url = '@/CodeSolutions2/audio_2_text_webapp/main/'+Object.values(row.file_name).toString(); // TypeError: can't convert undefined to object

			let blob_url = '@/run/media/oem2/3365-6330/audio_run_mp3/2024_03_13_09_57_51_test0.mp3';
			console.log("blob_url:", blob_url);

			// REST API to convert .mp3 to text
			//var url = 'https://api.openai.com/v1/audio/transcriptions';
			//var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			//var form = {"file": blob_url, 'model': 'whisper-1'};
			//var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			
			// Print text part of JSON response only with user message
			//const text_out = await fetch(url, options).then(res => res.json()).then(res => { console.log(JSON.parse(JSON.stringify(res))); return JSON.parse(JSON.stringify(res))}).catch(error => { console.log(error); }
			
			// Create a dictionary w/ date, time, and text
			// dict_out.push({date: date.join(), time: time.join(), text: text_out});
		  });

		   // Processing information
		   outp.innerHTML = 'Processing audio';
				   
		  });

	 outp.innerHTML = 'Processing Done';
	console.log("dict_out:", dict_out);
	
	return dict_out;
}


async function get_URLBlob() {
	
	const repoOwner = 'CodeSolutions2';
	const repoName = 'audio_2_text_webapp';
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	// url_vec should be a dictionary
	var url_vec = [];
	var date = [];
	await fetch(url).then(res => res.json()).then(data => {
		    data.forEach(file => {
		      if (file.type === 'file' && file.name.match(/.(mp3)$/i)) {
			url_vec.push({file_name: file.name, url_name: file.download_url});
		      }
		    });
		  }).catch(error => { outp.innerHTML += error; });
	
    	console.log('url_vec: ', url_vec);
	
	return url_vec;
}


// ----------------------------------------------------


  
</script>

  </body>
</html>
