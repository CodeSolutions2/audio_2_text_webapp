<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    
<!-- <input id="mp3name_id" type="text" value="" placeholder="mp3name" rows="10" cols="100" style="display:block; text-align: left; width: 150px;"> -->
<label id="directions" style="display:block">Enter OpenAI key to transcribe the audio files to text. All audio files in the repository will be transcribed.</label>
<br>
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">

<br><br>

<button id="readaudio" onclick="readaudio()">Transcribe audios</button>

<!-- View results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>


<!-- View results -->
<div align="left">
    <table style='text-align: center; width: 600px; display:block'>
      <tr>
        <td>
		<label id="journal_label" style="display:block">Journal text</label>
      		<br>
      		<textarea id="journal" rows="35" cols="100" placeholder="Journal text" style="display:block"></textarea>
	</td>
        <td>
		<label id="chatbot_label" style="display:block">Chatbot area</label>
      		<br>
      		<textarea id="chatbot" rows="35" cols="100" placeholder="Chatbot text" style="display:block"></textarea>
	</td>
      </tr>
    </table>
</div>  
    



	  
<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 2;},
  table {border-collapse: collapse; position: absolute;}
  td,
  th {border: 1px solid black;padding: 10px 20px;}
</style>

	  
<!-- --------------------------------------------------- -->
	  


	  
<script>


const outp = document.getElementById('output');


// ----------------------------------------------------
	
async function readaudio() {

  const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;
	
	return await get_URLBlob()
	.then(url_list => { console.log("url_list:", url_list);
		var dict_out = [];
		url_list.forEach(async function(row, index) {
			let filename = Object.values(row.file_name).toString();
			let out0 = filename.split('_');

			// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date
			let YYYY = out0.slice(0,1).toString();
			let MM = out0.slice(1,2).toString();
			let DD = out0.slice(2,3).toString();
			let HH = out0.slice(3,4).toString();
			let mm = out0.slice(4,5).toString();
			let ss = out0.slice(5,6).toString();

			const regex = /(,)+/g;
			
			YYYY = YYYY.replace(regex, '');
			MM = MM.replace(regex, '');
			DD = DD.replace(regex, '');
			HH = HH.replace(regex, '');
			mm = mm.replace(regex, '');
			ss = ss.replace(regex, '');
			console.log("YYYY:", YYYY);
			console.log("MM:", MM);
			console.log("DD:", DD);
			console.log("HH:", HH);
			console.log("mm:", mm);
			console.log("ss:", ss);

			// -----------------------------------

			let blob_url0 = Object.values(row.url_name).join();
			let blob_url = blob_url0.replace(regex, '');
			
			// let blob_url = '@'+Object.values(row.url_name);
			
			// let blob_url = '@'+Object.values(row.url_name).toString(); // TypeError: can't convert undefined to object  // blob_url: @h,t,t,p,s,:,/,/,r,a,w,.,g,i,t,h,u,b,u,s,e,r,c,o,n,t,e,n,t,.,c,o,m,/,C,o,d,e,S,o,l,u,t,i,o,n,s,2,/,a,u,d,i,o,_,2,_,t,e,x,t,_,w,e,b,a,p,p,/,m,a,i,n,/,2,0,2,4,_,0,3,_,1,3,_,0,9,_,5,7,_,5,1,_,t,e,s,t,0,.,m,p,3
			
			// let blob_url = '@/CodeSolutions2/audio_2_text_webapp/main/'+Object.values(row.file_name).toString(); // TypeError: can't convert undefined to object

			//let blob_url = '@/run/media/oem2/3365-6330/audio_run_mp3/2024_03_13_09_57_51_test0.mp3';  // message: "1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)", type: "invalid_request_error"
			// -----------------------------------
			
			console.log("blob_url:", blob_url);

			// REST API to convert .mp3 to text
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// { message: "Cannot specify both model and engine", type: "invalid_request_error", param: null, … }
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// { message: "Cannot specify both model and engine", type: "invalid_request_error", param: null, … }
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// message: "Invalid URL (POST /v1/engines/whisper-1/completions)", type: "invalid_request_error", param: null,
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/davinci/transcribe';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {audio: blob_url};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// message: "The model `davinci` has been deprecated, learn more here: https://platform.openai.com/docs/deprecations", type: "invalid_request_error", code: "model_not_found", … }

			// OR

			// var model_name = 'gpt-4';
			// var temperature = 0;
			// var system_content = "You are a helpful assistant";
			// var prompt = "Transcribe the following .mp3 audio: "+blob_url;
			// var assistant_content = "Respond concisely";
			// var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": prompt}, {"role": "assistant", "content": assistant_content}];
  			// var data = {"model": model_name, 'messages': messages, 'temperature': temperature};
  			// var url = 'https://api.openai.com/v1/chat/completions'
  			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY}
  			// var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
			// role: "assistant", content: "I'm sorry, but as a text-based AI, I'm unable to process or transcribe audio files."

			// OR
			
			// https://cdn.jsdelivr.net/npm/openai@4.33.0/index.min.js 
			// const transcript = await transcribe(blob_url);
			// var model_name = 'gpt-4';
			// var temperature = 0;
			// var system_content = "You are a helpful assistant";
			// var assistant_content = "Transcribe the following audio concisely";
			// var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": transcript}, {"role": "assistant", "content": assistant_content}];
			// var data = {"model": model_name, 'messages': messages, 'temperature': temperature};
			// var url = 'https://api.openai.com/v1/chat/completions'
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY}
			// var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
			// Uncaught ReferenceError: exports is not defined <anonymous> jsdelivr-header.js:7

			// OR

			// Tried audio instead of file
			// Tried json response instead of multi-part form
			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// 1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)
			
			// OR

			// Tried file instead of audio
			// Tried multi-part form instead of json response
			// https://platform.openai.com/docs/guides/speech-to-text/quickstart?lang=curl
			var url = 'https://api.openai.com/v1/audio/transcriptions';
			var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			var form = {"file": blob_url, 'model': 'whisper-1'};
			var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// 1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)
			
			// OR

			// Tried file instead of audio, added a type parameter
			// Tried multi-part form instead of json response
			// https://platform.openai.com/docs/guides/speech-to-text/quickstart?lang=curl
			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY}; // { message: "Could not parse multipart form", type: "invalid_request_error", param: null, … }
			// var form = {"file": blob_url, 'type': 'mp3', 'model': 'whisper-1'};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// 1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)
			
			// OR

			// ------------------------------------------
			
			// Print text part of JSON response only with user message
			const text_out = await fetch(url, options).then(res => res.json()).then(res => { console.log(JSON.parse(JSON.stringify(res))); return JSON.parse(JSON.stringify(res))}).catch(error => { console.log(error); });
			
			// Create a dictionary w/ date, time, and text
			dict_out.push({date: [YYYY, MM, DD], time: [HH, mm, ss], text: text_out});

			// Processing information
			outp.innerHTML = 'Processing audio';
		  });

		   outp.innerHTML = 'Processing Done'; console.log("dict_out:", dict_out); return dict_out; 
	});
}


async function get_URLBlob() {
	
	const repoOwner = 'CodeSolutions2';
	const repoName = 'audio_2_text_webapp';
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	// url_vec should be a dictionary
	var url_vec = [];
	var date = [];
	await fetch(url).then(res => res.json()).then(data => {
		    data.forEach(file => {
		      if (file.type === 'file' && file.name.match(/.(mp3)$/i)) {
			url_vec.push({file_name: file.name, url_name: file.download_url});
		      }
		    });
		  }).catch(error => { outp.innerHTML += error; });
	
    	console.log('url_vec: ', url_vec);
	
	return url_vec;
}


// ----------------------------------------------------


  
</script>

  </body>
</html>
