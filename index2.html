<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    
<!-- <input id="mp3name_id" type="text" value="" placeholder="mp3name" rows="10" cols="100" style="display:block; text-align: left; width: 150px;"> -->
	  
<label id="directions" style="display:block">Enter OpenAI key to transcribe the audio files to text. All audio files in the repository will be transcribed.</label>
	  
<br>
	  
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">

<!-- <form id="formElement_id" name="formElement" action="https://api.openai.com/v1/audio/transcriptions" method="POST" onsubmit="return checkForm(this)"> -->
	
<br><br>

<button id="readaudio" onclick="readaudio()">Transcribe audios</button>

<!-- View results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>


<!-- View results -->
<div align="left">
    <table style='text-align: center; width: 600px; display:block'>
      <tr>
        <td>
		<label id="journal_label" style="display:block">Journal text</label>
      		<br>
      		<textarea id="journal" rows="35" cols="100" placeholder="Journal text" style="display:block"></textarea>
	</td>
        <td>
		<label id="chatbot_label" style="display:block">Chatbot area</label>
      		<br>
      		<textarea id="chatbot" rows="35" cols="100" placeholder="Chatbot text" style="display:block"></textarea>
	</td>
      </tr>
    </table>
</div>  
    



	  
<!-- --------------------------------------------------- -->

<!-- CSS -->
<style>
div {position: relative; z-index: 2;},
  table {border-collapse: collapse; position: absolute;}
  td,
  th {border: 1px solid black;padding: 10px 20px;}
</style>

	  
<!-- --------------------------------------------------- -->
	  


	  
<script>


const outp = document.getElementById('output');

const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;

var filename = '';
	
// ----------------------------------------------------
	
async function readaudio() {
	
	return await get_file_objects()
	.then(file_objects => { console.log("file_objects:", file_objects);
		var dict_out = [];
		file_objects.forEach(async function(file_object, index) {
			
			console.log("file_object:", file_object);
			
			filename = file_object.name;
			console.log("filename:", filename);
			
			let out0 = filename.split('_');

			// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date
			let YYYY = out0.slice(0,1).toString();
			let MM = out0.slice(1,2).toString();
			let DD = out0.slice(2,3).toString();
			let HH = out0.slice(3,4).toString();
			let mm = out0.slice(4,5).toString();
			let ss = out0.slice(5,6).toString();

			const regex = /(,)+/g;
			
			YYYY = YYYY.replace(regex, '');
			MM = MM.replace(regex, '');
			DD = DD.replace(regex, '');
			HH = HH.replace(regex, '');
			mm = mm.replace(regex, '');
			ss = ss.replace(regex, '');
			console.log("YYYY:", YYYY);
			console.log("MM:", MM);
			console.log("DD:", DD);
			console.log("HH:", HH);
			console.log("mm:", mm);
			console.log("ss:", ss);

			// -----------------------------------

			let file_url = file_object.url;
			console.log("file_url:", file_url);
			
			// -----------------------------------

			// REST API to convert .mp3 to text
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// { message: "Cannot specify both model and engine", type: "invalid_request_error", param: null, … }
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// { message: "Cannot specify both model and engine", type: "invalid_request_error", param: null, … }
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/whisper-1/completions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// message: "Invalid URL (POST /v1/engines/whisper-1/completions)", type: "invalid_request_error", param: null,
			
			// OR
			
			// var url = 'https://api.openai.com/v1/engines/davinci/transcribe';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {audio: blob_url};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// message: "The model `davinci` has been deprecated, learn more here: https://platform.openai.com/docs/deprecations", type: "invalid_request_error", code: "model_not_found", … }

			// OR

			// var model_name = 'gpt-4';
			// var temperature = 0;
			// var system_content = "You are a helpful assistant";
			// var prompt = "Transcribe the following .mp3 audio: "+blob_url;
			// var assistant_content = "Respond concisely";
			// var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": prompt}, {"role": "assistant", "content": assistant_content}];
  			// var data = {"model": model_name, 'messages': messages, 'temperature': temperature};
  			// var url = 'https://api.openai.com/v1/chat/completions'
  			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY}
  			// var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
			// role: "assistant", content: "I'm sorry, but as a text-based AI, I'm unable to process or transcribe audio files."

			// OR
			
			// https://cdn.jsdelivr.net/npm/openai@4.33.0/index.min.js 
			// const transcript = await transcribe(blob_url);
			// var model_name = 'gpt-4';
			// var temperature = 0;
			// var system_content = "You are a helpful assistant";
			// var assistant_content = "Transcribe the following audio concisely";
			// var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": transcript}, {"role": "assistant", "content": assistant_content}];
			// var data = {"model": model_name, 'messages': messages, 'temperature': temperature};
			// var url = 'https://api.openai.com/v1/chat/completions'
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY}
			// var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
			// Uncaught ReferenceError: exports is not defined <anonymous> jsdelivr-header.js:7

			// ------------------------------------
			// https://platform.openai.com/docs/guides/speech-to-text/quickstart?lang=curl
			// ------------------------------------

			// Tried file instead of audio
			// Tried multi-part form instead of json response
			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {"file": blob_url, 'model': 'whisper-1'};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// message: "Could not parse multipart form", type: "invalid_request_error", param: null, … }

			// OR

			// Tried audio instead of file
			// Tried json response instead of multi-part form
			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {model: 'whisper-1', prompt: 'Transcribe the following audio:', audio: blob_url};
			// var options = {method : 'post', headers: headers, body : JSON.stringify(form)};
			// 1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)
			
			// OR

			// added a type parameter
			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY}; 
			// var form = {"file": blob_url, 'type': 'mp3', 'model': 'whisper-1'};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// 1 validation error for Request\nbody -> file\n  field required (type=value_error.missing)
			
			// OR

			// Tring translations
			// var url = 'https://api.openai.com/v1/audio/translations';
			// var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY}; 
			// var form = {"file": blob_url, "model": 'whisper-1'};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// message: "Could not parse multipart form", type: "invalid_request_error", param: null
			
			// OR

			// var url = 'https://api.openai.com/v1/audio/transcriptions';
			// var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
			// var form = {"file": blob_url, 'model': 'whisper-1', "language": "en"};
			// var options = {method : 'POST', headers: headers, body : JSON.stringify(form)};
			// message: "Could not parse multipart form", type: "invalid_request_error", param: null
			// means that the request needs to be a real form

			// OR
			
			// ------------------------------------------
			// Form submission
			// ------------------------------------------
			// Way 0
			
			// Convert the file_url to a blob
			var text_out = await fetch(file_url)
  				.then(response => response.blob())
				.then(async function(blob_object) { 
					console.log("blob_object: ", blob_object); 
					var text_out = await send_a_form_w_fetch_using_formData(blob_object);
					return text_out; })
				.catch(error => { console.log(error); });
			
			// var text_out = await send_a_form_w_fetch_using_formData(blob_url_obj).catch(error => { console.log(error); });

			// Way 1
			// var text_out = await send_a_form_w_formElement_using_formData(blob_url_obj).then(res => { console.log(res); return res; }).catch(error => { console.log(error); });

			// Way 2
			// var text_out = await send_a_form_w_formElement_using_input(blob_url_obj).then(res => { console.log(res); return res; }).catch(error => { console.log(error); });

			// ------------------------------------------
			
			// Print text part of JSON response only with user message
			// const text_out = await fetch(url, options).then(res => res.json()).then(res => { console.log(JSON.parse(JSON.stringify(res))); return JSON.parse(JSON.stringify(res))}).catch(error => { console.log(error); });
			
			// ------------------------------------------
			
			// Create a dictionary w/ date, time, and text
			dict_out.push({date: [YYYY, MM, DD], time: [HH, mm, ss], text: text_out});

			// Processing information
			outp.innerHTML = 'Processing audio';
		  });

		   outp.innerHTML = 'Processing Done'; console.log("dict_out:", dict_out); return dict_out; 
	});
}

			

			


	
// ----------------------------------------------------


async function send_a_form_w_fetch_using_formData(blob_object) {
	
	var url = 'https://api.openai.com/v1/audio/transcriptions';
	var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
	// OR
	// headers = new Headers(headers);
	
	let formData = new FormData();
	formData.append("file", blob_object, filename);
	// formData.append("file", blob_object);
	formData.append("model", "whisper-1");
	formData.append("language", "en");
	
	var options = {method : 'POST', headers: headers, body : formData};
	// without filename = message: "Could not parse multipart form", type: "invalid_request_error", param: null
	// with filename = TypeError: FormData.append: Argument 2 is not an object.

	// ------------------------------------------
	
	// Print text part of JSON response only with user message
	return await fetch(url, options).then(res => res.json()).then(res => { console.log(JSON.parse(JSON.stringify(res))); return JSON.parse(JSON.stringify(res))}).catch(error => { console.log(error); });
	
}

	
// ----------------------------------------------------
	

async function send_a_form_w_formElement_using_formData(blob_url_obj) {

	// Way 0
	// Create <form> element to ONLY a
	var formElement = document.createElement('form');
	// OR
	// var formElement = document.querySelector('form');

	// ------------------------
	// Tell the [fetch function included inside formElement.submit()] where to send the form information
	// ------------------------
	formElement.setAttribute('id', 'formElement_id');
	formElement.setAttribute('method', 'POST');

	var url = 'https://api.openai.com/v1/audio/transcriptions';
	formElement.setAttribute('action', url);
	
	var headers = {"Content-Type": "multipart/form-data", "Authorization": 'Bearer ' + OPENAI_API_KEY};
	formElement.setAttribute('headers', new Headers(headers));

	formElement.setAttribute('enctype', "multipart/form-data");
	formElement.setAttribute('target', "_blank");
	// ------------------------
	

	// ------------------------
	// Define the form information
	// This is the formData written in terms of an inputElement.
	// Using input one can define the type, name, and value; one can not define these in formData.
	// ------------------------
	// Add formData to the formElement
	let formData = new FormData();
	formData.append("file", blob_url_obj);
	// formData.append("file", blob_url_obj, blob_url_obj.name);
	// TypeError: FormData.append: Argument 2 does not implement interface Blob.
	formData.append("model", "whisper-1");
	formData.append("language", "en");
	
	// Add on other information in the [fetch function included inside formElement.submit()]
	formData.append("confirm_submit", "Submit");
	formData.append("method", "POST");
	formData.append("headers", headers);
	formData.append("enctype", 'multipart/form-data');
	
	formElement.appendChild(formData);
	// ------------------------
	
	// Add form to page and submit it to open the endpoint.
	document.body.appendChild(formElement);

	formElement.submit();

}
	
	
// ----------------------------------------------------

	
async function send_a_form_w_formElement_using_input(blob_url_obj) {

	// Way 0
	// Create <form> element to submit parameters to endpoint
	var formElement = document.createElement('form');
	// OR
	// var formElement = document.querySelector('form');
	
	// ------------------------
	// Tell the [fetch function included inside formElement.submit()] where to send the form information
	// ------------------------
	// Set the attributes of the formElement such that the formElement can send the fetch request
	formElement.setAttribute('id', 'formElement_id');
	formElement.setAttribute('method', 'POST');

	var url = 'https://api.openai.com/v1/audio/transcriptions';
	formElement.setAttribute('action', url);
	
	var headers = {'Content-Type': 'multipart/form-data', Authorization: 'Bearer ' + OPENAI_API_KEY};
	formElement.setAttribute('headers', new Headers(headers));

	formElement.setAttribute('enctype', 'multipart/form-data');
	formElement.setAttribute('target', '_blank');
	// ------------------------

	
	// ------------------------
	// Define the form information
	// This is the formData written in terms of an inputElement.
	// Using input one can define the type, name, and value; one can not define these in formData.
	// ------------------------
	// Just use arrays: each column is a form variable
	let type_parameters = ['file', 'text', 'text', 'submit', 'text', 'text', 'text'];
	var name_parameters = [blob_url_obj.name, 'model', 'language', 'confirm_submit', 'method', 'headers', 'enctype'];
	var value_parameters = [blob_url_obj, 'whisper-1', 'en', 'Submit', 'POST', headers, 'multipart/form-data'];
	
	type_parameters.forEach(async function(type_val, index) {
		let type = type_val;
		let name = name_parameters[index];
		let value = value_parameters[index];
		
		var input = document.createElement('input');
		input.innerHTML = '<input style="display:none;" type=' +type+ ' name=' +name+ 'value=' +value+ '>';
		formElement.appendChild(input);
	});
	// ------------------------
	
	// Add form to page and submit it to open the endpoint.
	document.body.appendChild(formElement);

	formElement.submit();

}


// ----------------------------------------------------
	

// Add an eventlistener to a button, when the button is clicked, do not redirect AND output the form results
// Do not redirect page to the page that we want to perform GET,POST requests with
// document.getElementById("formElement_id").addEventListener("onsubmit", (event) => {
// 	event.preventDefault();
// });


// The onsubmit ONLY in 'form action' allows one to call a function after the form is submitted
// function checkForm(thisForm){
// 	thisForm.preventDefault();
// }



// ----------------------------------------------------

	
async function get_file_objects() {
	
	const repoOwner = 'CodeSolutions2';
	const repoName = 'audio_2_text_webapp';
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	var file_objects = [];
	var date = [];
	await fetch(url).then(res => res.json()).then(data => {
		    data.forEach(file => {
		      if (file.type === 'file' && file.name.match(/.(mp3)$/i)) {
			file_objects.push(file);
		      }
		    });
		  }).catch(error => { outp.innerHTML += error; });
	
    	console.log('file_objects: ', file_objects);
	
	return file_objects;
}


// ----------------------------------------------------


  
</script>

  </body>
</html>
